name: AI Code Review

on:
  pull_request:
    branches: [main]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r requirements.txt

      - name: Get PR diff
        run: |
          git diff origin/main...HEAD > pr_diff.txt

      - name: Run AI review
        id: ai-review
        continue-on-error: true
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          set +e
          REVIEW=$(python scripts/ai_review.py pr_diff.txt)
          EXIT_CODE=$?
          set -e

          # If the AI call failed (quota/rate/etc), record that and move on
          if [ $EXIT_CODE -ne 0 ] || [ -z "$REVIEW" ]; then
            echo "review=AI review skipped (Gemini quota/rate limit or runtime error)." >> $GITHUB_OUTPUT
            echo "severity=SKIPPED" >> $GITHUB_OUTPUT
            echo "skipped=true" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "review<<EOF" >> $GITHUB_OUTPUT
          echo "$REVIEW" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

          SEVERITY=$(echo "$REVIEW" | grep "SEVERITY_SUMMARY" | cut -d':' -f2 | tr -d ' ')
          if [ -z "$SEVERITY" ]; then
            SEVERITY="WARNING"
          fi

          echo "severity=$SEVERITY" >> $GITHUB_OUTPUT
          echo "skipped=false" >> $GITHUB_OUTPUT

      - name: Post review comment
        if: steps.ai-review.outputs.skipped != 'true'
        uses: actions/github-script@v7
        env:
          REVIEW: ${{ steps.ai-review.outputs.review }}
        with:
          script: |
            const review = process.env.REVIEW;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `## ðŸ¤– AI Code Review\n\n${review}\n\n---\n*Powered by Gemini AI*`
            });

      - name: Apply severity label
        if: steps.ai-review.outputs.skipped != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const severity = '${{ steps.ai-review.outputs.severity }}';

            const labelMap = {
              'CRITICAL': 'ai-review: critical',
              'WARNING': 'ai-review: warning',
              'GOOD': 'ai-review: looks-good'
            };

            const label = labelMap[severity] || labelMap['WARNING'];

            // Remove any existing ai-review labels
            const currentLabels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            for (const existingLabel of currentLabels.data) {
              if (existingLabel.name.startsWith('ai-review:')) {
                await github.rest.issues.removeLabel({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: context.issue.number,
                  name: existingLabel.name
                });
              }
            }

            // Add the new severity label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              labels: [label]
            });

            console.log(`Applied label: ${label}`);
